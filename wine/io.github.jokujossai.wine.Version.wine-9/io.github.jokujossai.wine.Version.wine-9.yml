id: io.github.jokujossai.wine.Version.wine-9
branch: '25.08'
runtime: io.github.jokujossai.wine.base
runtime-version: '25.08'
sdk: org.freedesktop.Sdk//25.08
build-extension: true
separate-locales: false
appstream-compose: false

sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
  - org.freedesktop.Sdk.Extension.mingw-w64

x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: ${FLATPAK_DEST}/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  ldflags: -L${FLATPAK_DEST}/lib32 -Wl,-rpath-link=${FLATPAK_DEST}/lib32 -Wl,-z,relro,-z,now -Wl,--as-needed
  ldflags-override: true
  append-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: ccache i686-unknown-linux-gnu-gcc
    CXX: ccache i686-unknown-linux-gnu-g++
  libdir: ${FLATPAK_DEST}/lib32

build-options:
  prefix: /app/wine/wine-9
  prepend-path: /app/wine/wine-9/bin
  append-path: /usr/lib/sdk/mingw-w64/bin
  cflags: -std=gnu17
  cxxflags: -std=gnu++17
  config-opts:
    - CROSSCFLAGS=-std=gnu17

modules:

  # Wine

  # Native arch build

  - name: wine
    build-options:
      arch:
        x86_64:
          config-opts:
            - --enable-win64
            - --with-mingw="ccache x86_64-w64-mingw32-gcc"
    config-opts: &wine-config-opts
      - --disable-tests
      - --with-x
      - --with-pulse
      - --with-dbus
      - --without-hal
      - --without-oss
    make-install-args: &wine-make-install-args
      - LDCONFIG=/bin/true
      - UPDATE_DESKTOP_DATABASE=/bin/true
      - INSTALL_PROGRAM_FLAGS=-s
    post-install:
      - ln -sf /app/share/wine/support/gecko ${FLATPAK_DEST}/share/wine/gecko
      - ln -sf /app/share/wine/support/mono ${FLATPAK_DEST}/share/wine/mono
    sources: &wine-sources
      - type: archive
        url: https://dl.winehq.org/wine/source/9.x/wine-9.22.tar.xz
        sha256: e150d29742aa54f768ef3e976ed861aaa4f9f48542e409bea902d0f49b359683
        x-addons-url: &wine-addons-url >-
          https://gitlab.winehq.org/wine/wine/-/raw/master/dlls/appwiz.cpl/addons.c
        x-checker-data:
          type: html
          url: https://dl.winehq.org/wine/source/9.x/
          version-pattern: wine-(\d+\.[\d.]+)\.tar\.xz
          url-template: https://dl.winehq.org/wine/source/9.x/wine-$version.tar.xz
          versions:
            <: '10.0'
          is-main-source: true

  # 32-bit compatibility build

  - name: wine-32bit
    only-arches:
      - x86_64
    build-options:
      arch:
        x86_64: *compat_i386_opts
      config-opts:
        - --bindir=${FLATPAK_DEST}/bin32
        - --with-mingw="ccache i686-w64-mingw32-gcc"
    config-opts: *wine-config-opts
    make-install-args: *wine-make-install-args
    post-install:
      - mv ${FLATPAK_DEST}/bin32/wine{,-preloader} ${FLATPAK_DEST}/bin/
    sources: *wine-sources

  # Tools

  - ../modules/winetricks.yml
