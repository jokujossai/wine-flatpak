id: io.github.jokujossai.wine.base
default-branch: '25.08'
sdk: org.freedesktop.Sdk
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
x-gl-version: &gl-version '1.4'
x-gl-versions: &gl-versions 25.08;25.08-extra;1.4
x-gl-merge-dirs: &gl-merge-dirs vulkan/icd.d;glvnd/egl_vendor.d;egl/egl_external_platform.d;OpenCL/vendors;lib/dri;lib/d3d;lib/gbm;vulkan/explicit_layer.d;vulkan/implicit_layer.d;vdpau
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=all
  - --socket=pulseaudio
  - --share=network
  - --allow=multiarch
  - --allow=devel
  - --system-talk-name=org.freedesktop.UDisks2
  - --filesystem=xdg-desktop
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
  - --filesystem=xdg-download
  - --env=WINEPREFIX=/var/data/wine
  - --env=GST_PLUGIN_SYSTEM_PATH=/app/lib/gstreamer-1.0:/app/lib32/gstreamer-1.0:/usr/lib/extensions/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/codecs-extra/lib/gstreamer-1.0:/usr/lib/i386-linux-gnu/codecs-extra/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:/usr/lib/i386-linux-gnu/gstreamer-1.0

add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version

  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: *runtime-version
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: *gl-merge-dirs
    download-if: active-gl-driver
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.GL32.Debug:
    directory: lib/debug/lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    merge-dirs: *gl-merge-dirs
    enable-if: active-gl-driver
    autoprune-unless: active-gl-driver

  org.freedesktop.Platform.VAAPI.Intel.i386:
    directory: lib/i386-linux-gnu/dri/intel-vaapi-driver
    version: *runtime-version
    versions: *runtime-version
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-intel-gpu
    autoprune-unless: have-intel-gpu

  org.freedesktop.Platform.VAAPI.nvidia.i386:
    directory: i386/nvidia-vaapi-driver
    version: *runtime-version
    versions: *runtime-version
    autodelete: false
    no-autodownload: true
    add-ld-path: lib
    download-if: have-kernel-module-nvidia
    autoprune-unless: have-kernel-module-nvidia

  org.freedesktop.Platform.codecs_extra.i386:
    directory: lib/i386-linux-gnu/codecs-extra
    version: 25.08-extra
    autodelete: false
    add-ld-path: lib

  io.github.jokujossai.wine.gecko:
    directory: share/wine/gecko
    version: stable
    no-autodownload: true

  io.github.jokujossai.wine.mono:
    subdirectories: true
    directory: share/wine
    version: stable
    no-autodownload: true
    merge-dirs: mono

  io.github.jokujossai.gamescope:
    directory: extensions/gamescope
    version: stable
    add-ld-path: lib
    no-autodownload: true

  io.github.jokujossai.wine.Version:
    subdirectories: true
    directory: wine
    version: '25.08'
    versions: '25.08'
    no-autodownload: true
    add-ld-path: lib

sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386
  - org.freedesktop.Sdk.Extension.mingw-w64

build-options:
  append-path: /usr/lib/sdk/mingw-w64/bin
  env:
    PERL5LIB: /app/lib/perl5/
    PERL_MM_OPT: INSTALL_BASE=/app

x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  # Some autotools-based builds will fail if -L/app/lib32 isn't first
  ldflags: -L/app/lib32 -Wl,-rpath-link=/app/lib32 -Wl,-z,relro,-z,now -Wl,--as-needed
  ldflags-override: true
  append-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: ccache i686-unknown-linux-gnu-gcc
    CXX: ccache i686-unknown-linux-gnu-g++
  libdir: /app/lib32

separate-locales: false
cleanup:
  - '*.a'
  - '*.la'
  - /share/et
  - /share/examples
  - /share/man
  - /bin32
  - /include
  - /lib/pkgconfig
  - /lib32/pkgconfig
cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/i386-linux-gnu/codecs-extra
modules:

  # Wine dependencies

  - name: krb5
    subdir: src
    build-options:
      config-opts:
        - --sbindir=${FLATPAK_DEST}/bin
    config-opts: &krb5-config-opts
      - --localstatedir=/var/lib
      - --disable-rpath
    sources: &krb5-sources
      - type: archive
        url: https://kerberos.org/dist/krb5/1.22/krb5-1.22.1.tar.gz
        sha256: 1a8832b8cad923ebbf1394f67e2efcf41e3a49f460285a66e35adec8fa0053af
        x-checker-data:
          type: anitya
          project-id: 13287
          stable-only: true
          url-template: https://kerberos.org/dist/krb5/${version0}.${version1}/krb5-${version0}.${version1}.${version2}.tar.gz

  - name: krb5-32bit
    subdir: src
    build-options:
      arch:
        x86_64: *compat_i386_opts
      config-opts:
        - --bindir=${FLATPAK_DEST}/bin32
        - --sbindir=${FLATPAK_DEST}/bin32
    config-opts: *krb5-config-opts
    sources: *krb5-sources

  - name: krb5-config
    buildsystem: simple
    build-commands:
      - install -Dm644 krb5.conf -t /app/etc
    sources:
      - type: file
        path: krb5.conf

  - name: unixodbc
    sources: &unixodbc-sources
      - type: archive
        url: https://www.unixodbc.org/unixODBC-2.3.14.tar.gz
        sha256: 4e2814de3e01fc30b0b9f75e83bb5aba91ab0384ee951286504bb70205524771
        x-checker-data:
          type: anitya
          project-id: 7344
          stable-only: true
          url-template: https://www.unixodbc.org/unixODBC-$version.tar.gz

  - name: unixodbc-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
      config-opts:
        - --bindir=${FLATPAK_DEST}/bin32
    sources: *unixodbc-sources

  - name: opencl-headers
    buildsystem: simple
    build-commands:
      - cp -a CL $FLATPAK_DEST/include/
    sources:
      - type: archive
        url: https://github.com/KhronosGroup/OpenCL-Headers/archive/refs/tags/v2025.07.22.tar.gz
        sha256: 98f0a3ea26b4aec051e533cb1750db2998ab8e82eda97269ed6efe66ec94a240
        x-checker-data:
          type: anitya
          project-id: 223257
          stable-only: true
          url-template: https://github.com/KhronosGroup/OpenCL-Headers/archive/refs/tags/v$version.tar.gz

  # Samba + dependencies - For ntlm_auth and other functionalities in Wine

  - name: parse-yapp
    buildsystem: simple
    build-commands:
      - perl Makefile.PL
      - make
      - make install
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://cpan.metacpan.org/authors/id/W/WB/WBRASWELL/Parse-Yapp-1.21.tar.gz
        sha256: 3810e998308fba2e0f4f26043035032b027ce51ce5c8a52a8b8e340ca65f13e5
        x-checker-data:
          type: anitya
          project-id: 3197
          stable-only: true
          url-template: https://cpan.metacpan.org/authors/id/W/WB/WBRASWELL/Parse-Yapp-$version.tar.gz

  - name: rpcsvc-proto
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/thkukuk/rpcsvc-proto/releases/download/v1.4.4/rpcsvc-proto-1.4.4.tar.xz
        sha256: 81c3aa27edb5d8a18ef027081ebb984234d5b5860c65bd99d4ac8f03145a558b
        x-checker-data:
          type: anitya
          project-id: 155452
          stable-only: true
          url-template: https://github.com/thkukuk/rpcsvc-proto/releases/download/v$version/rpcsvc-proto-$version.tar.xz

  - name: samba
    build-options:
      config-opts:
        - --sbindir=/app/bin
        - --libdir=/app/lib
        - --libexecdir=/app/lib/libexec
    config-opts: &samba-config-opts
      - --localstatedir=/var
      - --sharedstatedir=/var/lib
      - --enable-fhs
      - --disable-rpath
      - --disable-rpath-install
      - --disable-python
      - --disable-cups
      - --disable-iprint
      - --without-json
      - --without-ad-dc
      - --without-ads
      - --without-pam
      - --without-ldap
      - --without-acl-support
      - --without-systemd
      - --without-ldb-lmdb
      - --without-quotas
      - --without-syslog
      - --without-utmp
      - --without-dmapi
    sources: &samba-sources
      - type: archive
        url: https://samba.org/samba/ftp/stable/samba-4.23.4.tar.gz
        sha256: af429d078a86f1ce16d0d1ecee35c42a3610790b47b84468f31284a8c4060140
        x-checker-data:
          type: anitya
          project-id: 4758
          stable-only: true
          url-template: https://samba.org/samba/ftp/stable/samba-$version.tar.gz
      - type: patch
        path: samba-skip-setuid-check.patch

  - name: samba-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
      config-opts:
        - --bindir=/app/bin32
        - --sbindir=/app/bin32
        - --libexecdir=/app/lib32/libexec
    config-opts: *samba-config-opts
    sources: *samba-sources

  # Utilities

  - name: icon-cache-setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/icons/hicolor
      - touch /app/share/icons/hicolor/.icon-theme.cache

  - name: zenity
    buildsystem: meson
    sources:
      - type: archive
        url: https://download.gnome.org/sources/zenity/3.44/zenity-3.44.2.tar.xz
        sha256: 3fb5b8b1044d3d129262d3c54cf220eb7f76bc21bd5ac6d96ec115cd3518300e
        x-checker-data:
          type: gnome
          name: zenity
          versions:
            <: '4.0'

  - name: 7zip
    buildsystem: simple
    build-commands:
      - tar -xf 7z*-linux-x64.tar.xz 7zz
      - install -Dm755 7zz ${FLATPAK_DEST}/bin/7zz
      - ln -s 7zz ${FLATPAK_DEST}/bin/7z
      - ln -s 7zz ${FLATPAK_DEST}/bin/7za
    sources:
      - type: file
        url: https://7-zip.org/a/7z2501-linux-x64.tar.xz
        sha256: 4ca3b7c6f2f67866b92622818b58233dc70367be2f36b498eb0bdeaaa44b53f4
        x-checker-data:
          type: html
          url: https://7-zip.org/download.html
          version-pattern: 7z(\d+)-linux-x64\.tar\.xz
          url-template: https://7-zip.org/a/7z$version-linux-x64.tar.xz

  # Flatpak bundle

  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/etc ld.so.conf
      - install -Dm755 wine-desktop ${FLATPAK_DEST}/bin/wine-desktop
      - install -Dm755 wine-wrapper ${FLATPAK_DEST}/bin/wine-wrapper
      - install -Dm755 extract-iso.sh ${FLATPAK_DEST}/bin/extract-iso.sh
      - install -Dm755 entrypoint.sh ${FLATPAK_DEST}/bin/entrypoint.sh
      - ln -s wine-wrapper ${FLATPAK_DEST}/bin/wine
      - ln -s wine-wrapper ${FLATPAK_DEST}/bin/wineboot
      - ln -s wine-wrapper ${FLATPAK_DEST}/bin/winecfg
      - ln -s wine-wrapper ${FLATPAK_DEST}/bin/wineserver
      - ln -s wine-wrapper ${FLATPAK_DEST}/bin/winetricks
      - mkdir -p ${FLATPAK_DEST}/lib/i386-linux-gnu
      - mkdir -p ${FLATPAK_DEST}/lib/debug/lib/i386-linux-gnu
      - mkdir -p ${FLATPAK_DEST}/lib/i386-linux-gnu/GL
      - mkdir -p ${FLATPAK_DEST}/lib/debug/lib/i386-linux-gnu/GL
      - mkdir -p ${FLATPAK_DEST}/lib/i386-linux-gnu/dri/intel-vaapi-driver
      - mkdir -p ${FLATPAK_DEST}/i386/nvidia-vaapi-driver
      - mkdir -p ${FLATPAK_DEST}/share/wine/gecko
      - mkdir -p ${FLATPAK_DEST}/share/wine/mono
      - mkdir -p ${FLATPAK_DEST}/extensions/gamescope
      - mkdir -p ${FLATPAK_DEST}/wine
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: file
        path: ld.so.conf
      - type: file
        path: wine-desktop
      - type: file
        path: wine-wrapper
      - type: file
        path: extract-iso.sh
      - type: file
        path: entrypoint.sh
      - type: file
        path: io.github.jokujossai.wine.base.metainfo.xml
